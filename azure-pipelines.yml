# Ant
# Build your Java projects and run tests with Apache Ant.
# Add steps that save build artifacts and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- master
- release*
- conan

pr:
- master

strategy:
  matrix:
    linux:
      imageName: "ubuntu-18.04"
      CONAN_GCC_VERSIONS: 7
      CONAN_CLANG_VERSIONS: ""
    macHighSierra:
      imageName: "macos-10.13"
      CONAN_APPLE_CLANG_VERSIONS: 10.0
    macMojave:
      imageName: "macos-10.14"
      CONAN_APPLE_CLANG_VERSIONS: 11.0
    windows:
      imageName: "vs2017-win2016"
      CONAN_VISUAL_VERSIONS: 15
      CONAN_VISUAL_RUNTIMES: MD,MDd

  maxParallel: 4

pool:
  vmImage: $(imageName)

steps:
# Use Python version
- task: UsePythonVersion@0
  displayName: Switch to Python 3.7
  inputs:
    versionSpec: '3.7' 
    addToPath: true 
    architecture: 'x64'

- script: |
    pip install wheel
    pip install conan --upgrade
    conan user
    conan remote add simcenter https://api.bintray.com/conan/nheri-simcenter/simcenter --insert 0
    conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan
    conan remote list
  displayName: Conan Installation
  failOnStderr: false

- script: |
    conan install qt/5.9.8@bincrafters/stable -o qt:qt3d=True -o qt:qtcharts=True -g virtualrunenv --build missing
  displayName: Install Qt
  failOnStderr: false

  - script: |
    conan install . --build missing
    mkdir build
    cd build
    conan install qt/5.9.8@bincrafters/stable -o qt:qt3d=True -o qt:qtcharts=True -g virtualrunenv
    source activate_run.sh
    qmake ..
    make
  condition: or(eq( variables['Agent.OS'], 'Linux' ), eq( variables['Agent.OS'], 'Darwin' ))
  displayName: Build WE-UQ on Linux or MacOS
  failOnStderr: false

- script: |
    conan install . --build missing
    mkdir build
    cd build
    conan install qt/5.9.8@bincrafters/stable -o qt:qt3d=True -o qt:qtcharts=True -g virtualrunenv
    activate_run
    qmake ..
  condition: eq( variables['Agent.OS'], 'Windows_NT' )
  displayName: QMake WE-UQ on Windows
  failOnStderr: false

- script: |
    "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
    nmake release
  condition: eq( variables['Agent.OS'], 'Windows_NT' )
  displayName: Build WE-UQ on Windows
  failOnStderr: false